<div
  *ngIf="aberto"
  class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
>
  <div
    class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6"
  >
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Cadastrar nova pessoa</h2>
      <button (click)="onFechar()" class="text-gray-500 hover:text-gray-700">
        ✕
      </button>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <fieldset class="mb-8">
        <legend
          class="text-lg font-semibold text-indigo-700 border-b border-indigo-200 w-full pb-2 mb-6"
        >
          Dados de contato
        </legend>
        <div class="flex flex-col sm:flex-row sm:space-x-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tipo de Pessoa <span class="text-red-500">*</span></label
            >
            <div class="flex rounded-lg overflow-hidden border border-gray-300">
              <button
                type="button"
                name="tipo"
                value="PF"
                (click)="form.get('tipo')?.setValue('PF')"
                [ngClass]="{
                    'bg-blue-600 text-white font-semibold': isPessoaFisica,
                    'bg-gray-100 text-gray-700 hover:bg-gray-200': !isPessoaFisica
                  }"
                class="flex-1 py-2 transition-colors duration-150"
              >
                Pessoa Física (PF)
              </button>
              <button
                type="button"
                name="tipo"
                value="PJ"
                (click)="form.get('tipo')?.setValue('PJ')"
                [ngClass]="{
                    'bg-blue-600 text-white font-semibold': !isPessoaFisica,
                    'bg-gray-100 text-gray-700 hover:bg-gray-200': isPessoaFisica
                  }"
                class="flex-1 py-2 transition-colors duration-150 border-l border-gray-300"
              >
                Pessoa Jurídica (PJ)
              </button>
            </div>
          </div>
        </div>
        <div
          *ngIf="isPessoaFisica"
          class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border-4 border-blue-200 rounded-lg bg-blue-50"
        >
          <div class="md:col-span-2">
            <h3 class="text-lg font-semibold text-blue-800">Dados Pessoais</h3>
          </div>

          <div>
            <label for="nr_cpf" class="block text-sm font-medium text-gray-700"
              >CPF <span class="text-red-500">*</span></label
            >
            <input
              id="nr_cpf'"
              type="text"
              formControlName="nr_cpf"
              inputmode="numeric"
              mask="000.000.000-00"
              placeholder="000.000.000-00"
              type="text"
              class="mt-1 block w-full placeholder:text-slate-400 border rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500 text-gray-900 focus:outline-none"
              [ngClass]="{'border-red-500': isInvalid('nr_cpf'), 'border-gray-300': !isInvalid('nr_cpf') }"
              (blur)="onCpfBlur()"
            />
            <div *ngIf="form.get('nr_cpfj')?.errors?.['jaExiste']">
              Este CPF já está cadastrado.
            </div>
            <div
              class="mt-1 text-xs text-red-800"
              *ngIf="cpfValido === false"
              style="color: red"
              [ngClass]="tipoAlerta === 'error' ? 'alerta-erro' : 'alerta-sucesso'"
              role="alert"
            >
              É obrigatório CPF válido!
            </div>
            <div
              *ngIf="mensagemDeErro"
              [ngClass]="tipoAlerta === 'error' ? 'alerta-erro' : 'alerta-sucesso'"
              role="alert"
            >
              {{ mensagemDeErro }}
            </div>
          </div>
          <div>
            <label for="nome" class="block text-sm font-medium text-gray-700"
              >Nome Completo <span class="text-red-500">*</span></label
            >
            <input
              id="nome"
              type="text"
              formControlName="nome"
              placeholder="Nome completo"
              class="mt-1 block w-full placeholder:text-slate-400 border rounded-md shadow-sm p-3 focus:ring-blue-500 text-gray-900 focus:outline-none"
              [ngClass]="{'border-red-500': isInvalid('nome bbb'), 'border-gray-300': !isInvalid('nome bbbb')}"
            />
            <p
              *ngIf="form.get('nome')?.errors?.['required'] && isInvalid('nome')"
              class="mt-1 text-xs text-red-600"
            >
              O nome é obrigatório.
            </p>
          </div>
          <div class="md:col-span-1 lg:col-span-1">
            <label for="rg" class="block text-sm font-medium text-gray-700"
              >RG</label
            >
            <input
              id="rg"
              type="text"
              formControlName="rg"
              inputmode="numeric"
              mask="00.000.000-00"
              placeholder="00.000.000-00"
              type="text"
              class="mt-1 py-2 w-40 border rounded-md bg-transparent placeholder:text-slate-400 text-slate-700 text-lg border border-slate-200 rounded-md pl-2 transition duration-300 ease focus:outline-none focus:border-blue-500 hover:border-slate-500 shadow-sm focus:shadow"
            />
          </div>

          <div>
            <label
              for="nomeSocial"
              class="block text-sm font-medium text-gray-700"
              >Nome Social
            </label>
            <input
              id="rg"
              type="text"
              formControlName="rg"
              inputmode="test"
              placeholder="nome social"
              type="text"
              class="mt-1 py-2 w-70 border rounded-md bg-transparent placeholder:text-slate-400 text-slate-700 text-lg border border-slate-200 rounded-md pl-2 transition duration-300 ease focus:outline-none focus:border-blue-500 hover:border-slate-500 shadow-sm focus:shadow"
            />
          </div>
        </div>

        <div
          *ngIf="!isPessoaFisica"
          class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border-4 border-green-200 rounded-lg bg-green-50"
        >
          <div class="md:col-span-2">
            <h3 class="text-lg font-semibold text-green-800">
              Dados Empresariais
            </h3>
          </div>
          <div>
            <label for="nr_cnpj" class="block text-sm font-medium text-gray-700"
              >CNPJ <span class="text-red-500">*</span></label
            >
            <input
              id="nr_cnpj"
              type="text"
              formControlName="nr_cnpj"
              inputmode="numeric"
              mask="00.000.000/0000-00"
              placeholder="00.000.000/0000-00"
              type="text"
              class="mt-1 block w-full placeholder:text-slate-400 border rounded-md shadow-sm p-3 focus:ring-blue-500 focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{'border-red-500': isInvalid('nr_cnpj'), 'border-gray-300': !isInvalid('nr_cnpj') }"
              (blur)="onCnpjBlur()"
            />

            <div
              class="mt-1 text-xs text-red-800"
              *ngIf="cnpjValido === false"
              style="color: red"
              [ngClass]="tipoAlerta === 'error' ? 'alerta-erro' : 'alerta-sucesso'"
              role="alert"
            >
              ❌ É obrigatório CNPJ válido!
            </div>
            <div
              *ngIf="mensagemDeErro"
              [ngClass]="tipoAlerta === 'error' ? 'alerta-erro' : 'alerta-sucesso'"
              role="alert"
            >
              {{ mensagemDeErro }}
            </div>
          </div>
          <div>
            <label
              for="nmFantasia"
              class="block text-sm font-medium text-gray-700"
              >Nome Fantasia <span class="text-red-500">*</span></label
            >
            <input
              id="nmFantasia"
              type="text"
              formControlName="nmFantasia"
              placeholder="Nome Fantasia"
              class="mt-1 block w-full border placeholder:text-slate-400 rounded-md shadow-sm p-3 focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{'border-red-500': isInvalid('nmFantasia'), 'border-gray-300': !isInvalid('nmFantasia')}"
            />
            <p
              *ngIf="form.get('nmFantasia')?.errors?.['required'] && isInvalid('nmFantasia')"
              class="mt-1 text-xs text-red-600"
            >
              A Razão Social é obrigatória.
            </p>
          </div>

          <div class="md:col-span-2">
            <label
              for="rzSocial"
              class="block text-sm font-medium text-gray-700"
              >Razão Social <span class="text-red-500">*</span></label
            >
            <input
              id="rzSocial"
              type="text"
              formControlName="rzSocial"
              placeholder="Razão Social"
              class="mt-1 block w-full border rounded-md shadow-sm p-3 placeholder:text-slate-400 focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{'border-red-500': isInvalid('rzSocial'), 'border-gray-300': !isInvalid('rzSocial')}"
            />
            <p
              *ngIf="enderecoForm.get('rzSocial')?.errors?.['required'] && isInvalid('rzSocial')"
              class="mt-1 text-xs text-red-600"
            >
              O Nome Fantasia é obrigatório.
            </p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div class="md:col-span-2"></div>
        </div>
      </fieldset>

      <fieldset>
        <div class="md:col-span-2">
          <legend
            class="text-lg font-semibold text-indigo-700 border-b border-indigo-200 w-full pb-2 mb-6"
          >
            Contato (Celular, WhatsApp, Email)
          </legend>
        </div>

        <!-- Grid responsivo -->
        <div
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
        >
          <!-- Celular -->
          <div>
            <label for="celular" class="block text-sm font-medium text-gray-700"
              >Celular <span class="text-red-500">*</span></label
            >
            <input
              id="celular"
              type="text"
              mask="(00) 0 0000-0000"
              formControlName="celular"
              placeholder="Celular"
              class="mt-1 block w-full rounded-md shadow-sm p-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{'border-red-500': isInvalid('celular'), 'border-gray-300': !isInvalid('celular')}"
            />

            <p
              *ngIf="form.get('celular')?.errors?.['required'] && isInvalid('celular')"
              class="mt-1 text-xs text-red-600"
            >
              ❌ Celular inválido.
            </p>
            <p
              *ngIf="form.get('celular')?.errors?.['celularInvalido'] && isInvalid('celular') && !form.get('celular')?.errors?.['required']"
              class="mt-1 text-xs text-red-600"
            >
              ❌ inválido. Digite 11 dígitos: (DDD) 9 0000-0000
            </p>
          </div>

          <!-- WhatsApp -->
          <div>
            <label for="zap" class="block text-sm font-medium text-gray-700"
              >WhatsApp</label
            >
            <input
              id="zap"
              type="checkbox"
              formControlName="zap"
              class="w-6 h-6 mt-2 hover:bg-gray-300 focus:ring-green-500"
            />
          </div>

          <!-- Email -->
          <div class="md:col-span-2 lg:col-span-2">
            <label for="email" class="block text-sm font-medium text-gray-700"
              >Email</label
            >
            <input
              id="email"
              type="text"
              formControlName="email"
              placeholder="Email"
              class="mt-1 block w-full w-80 text-sm md:text-gray-400 border border-slate-200 rounded-md pl-2 py-3 transition duration-300 ease focus:outline-none focus:border-blue-500 hover:border-slate-300 shadow-sm focus:shadow"
            />
          </div>
        </div>
      </fieldset>

      <fieldset>
        <br />
        <div
          formGroupName="endereco"
          class="grid grid-cols-1 md:grid-cols-4 gap-1"
        >
          <div class="md:col-span-4">
            <legend
              class="text-lg font-semibold text-indigo-700 border-b border-indigo-200 w-full pb-2 mb-6"
            >
              Endereço completo
            </legend>
          </div>
          <div class="md:col-span-2 w-[120px]">
            <label for="cep" class="block text-sm font-medium text-gray-700"
              >CEP <span class="text-red-500">*</span></label
            >
            <input
              id="cep"
              type="text"
              formControlName="cep"
              placeholder="Pesquisar"
              inputmode="numeric"
              mask="00.000-000"
              maxlength="16"
              class="mt-1 block w-40 border placeholder:text-slate-400 rounded-md shadow-sm p-2 focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{
                'border-red-500': enderecoForm.get('cep')?.invalid && enderecoForm.get('cep')?.touched,
                'border-gray-300': enderecoForm.get('cep')?.valid || !enderecoForm.get('cep')?.touched
                }"
              (blur)="buscarCep()"
            />

            <div *ngIf="loading" class="mt-4 w-40 text-blue-500 text-sm">
              Buscando endereço...
            </div>
            <div *ngIf="erroBusca" class="mt-3 text-red-500 text-sm">
              CEP inválido ou não encontrado. Verifique o número.
            </div>
            <div
              *ngIf="enderecoForm.get('cep')?.errors && enderecoForm.get('cep')?.touched"
              class="mt-1 text-red-500"
            >
              <span
                *ngIf="enderecoForm.get('cep')?.errors?.['required'] "
                class="mt-1 text-red-600"
                >Obrigatório.</span
              >
              <span
                *ngIf="enderecoForm.get('cep')?.errors?.['pattern']"
                class="mt-1 text-xs text-red-600"
                >Formato inválido. Use 8 dígitos.</span
              >
            </div>
          </div>

          <div class="md:col-span-4">
            <div>
              <label
                for="logradouro"
                class="block text-sm font-medium text-gray-700"
                >Rua/Logradouro</label
              >
              <input
                id="logradouro"
                type="text"
                formControlName="logradouro"
                class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm cursor-not-allowed"
                readonly
              />
            </div>
          </div>
          <div class="md:col-span-1">
            <label for="numero" class="block text-sm font-medium text-gray-700"
              >Número <span class="text-red-500">*</span></label
            >
            <input
              id="numero"
              type="text"
              formControlName="numero"
              placeholder="Número"
              class="mt-1 block w-full placeholder:text-slate-400 border rounded-md shadow-sm p-2 focus:outline-none focus:border-blue-500 text-gray-900"
              [ngClass]="{
                'border-red-500': enderecoForm.get('numero')?.invalid && enderecoForm.get('numero')?.touched,
                'border-gray-300': enderecoForm.get('numero')?.valid || !enderecoForm.get('numero')?.touched
                }"
            />
            <div
              *ngIf="enderecoForm.get('numero')?.errors && enderecoForm.get('numero')?.touched"
              class="mt-1 text-red-500 text-sm"
            >
              Obrigatório.
            </div>
          </div>

          <div class="md:col-span-3">
            <label
              for="complemento"
              class="block text-sm font-medium text-gray-700"
              >Complemento (opcional)</label
            >
            <input
              id="complemento"
              type="text"
              formControlName="complemento"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="md:col-span-2">
            <div>
              <label
                for="bairro"
                class="block text-sm font-medium text-gray-700"
                >Bairro</label
              >
              <input
                id="bairro"
                type="text"
                formControlName="bairro"
                class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm cursor-not-allowed"
                readonly
              />
            </div>
          </div>
          <div class="md:col-span-2">
            <label for="cidade" class="block text-sm font-medium text-gray-700"
              >Cidade</label
            >
            <input
              id="cidade"
              type="text"
              formControlName="cidade"
              class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm cursor-not-allowed"
              readonly
            />
          </div>
          <div class="w-16">
            <label for="uf" class="block text-sm font-medium text-gray-700"
              >UF</label
            >
            <input
              id="uf"
              type="text"
              formControlName="uf"
              class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm cursor-not-allowed"
              readonly
            />
          </div>
        </div>
      </fieldset>

      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="px-3 py-1 bg-gray-200 rounded"
          (click)="onFechar()"
        >
          Cancelar
        </button>

        <button
          type="button"
          [disabled]="form.invalid"
          [ngClass]="{
                'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500': form.valid,
                'bg-gray-400 cursor-not-allowed': form.invalid}"
          class="px-3 py-1 bg-blue-600 text-white rounded"
          (click)="onSubmit() "
        >
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>
